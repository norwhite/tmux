/* $OpenBSD$ */

/*
 * Copyright (c) 2008 Nicholas Marriott <nicm@users.sourceforge.net>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF MIND, USE, DATA OR PROFITS, WHETHER
 * IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING
 * OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#include <sys/types.h>

#include <ctype.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>

#include "tmux.h"

/*
 * Colour to string conversion functions. Bit 8 of the colour means it is one
 * of the 256 colour palette.
 */

struct colour_rgb {
	u_char  i;
	u_char	r;
	u_char	g;
	u_char	b;
};

struct lab_index {
    u_char i;
    float  l;
    float  a;
    float  b;
};

struct colour_xyz {
    double x;
    double y;
    double z;
};


struct colour_lab {
    double L;
    double a;
    double b;
};

struct white_ref {
    double Xr;
    double Yr;
    double Zr;
};

struct cie_profile {
    double data[3][3];
};

const struct white_ref d65_white = { 0.95047, 1.0000001, 1.08883 };

const struct cie_profile srgb_d65 = {{
    { 0.4124564, 0.3575761, 0.1804375 },
    { 0.2126729, 0.7151522, 0.0721750 },
    { 0.0193339, 0.1191920, 0.9503041 },
}};
const struct colour_rgb colour_from_256[] = {
	{   0, 0x00, 0x00, 0x00 }, {   1, 0x00, 0x00, 0x5f },
	{   2, 0x00, 0x00, 0x87 }, {   3, 0x00, 0x00, 0xaf },
	{   4, 0x00, 0x00, 0xd7 }, {   5, 0x00, 0x00, 0xff },
	{   6, 0x00, 0x5f, 0x00 }, {   7, 0x00, 0x5f, 0x5f },
	{   8, 0x00, 0x5f, 0x87 }, {   9, 0x00, 0x5f, 0xaf },
	{  10, 0x00, 0x5f, 0xd7 }, {  11, 0x00, 0x5f, 0xff },
	{  12, 0x00, 0x87, 0x00 }, {  13, 0x00, 0x87, 0x5f },
	{  14, 0x00, 0x87, 0x87 }, {  15, 0x00, 0x87, 0xaf },
	{  16, 0x00, 0x87, 0xd7 }, {  17, 0x00, 0x87, 0xff },
	{  18, 0x00, 0xaf, 0x00 }, {  19, 0x00, 0xaf, 0x5f },
	{  20, 0x00, 0xaf, 0x87 }, {  21, 0x00, 0xaf, 0xaf },
	{  22, 0x00, 0xaf, 0xd7 }, {  23, 0x00, 0xaf, 0xff },
	{  24, 0x00, 0xd7, 0x00 }, {  25, 0x00, 0xd7, 0x5f },
	{  26, 0x00, 0xd7, 0x87 }, {  27, 0x00, 0xd7, 0xaf },
	{  28, 0x00, 0xd7, 0xd7 }, {  29, 0x00, 0xd7, 0xff },
	{  30, 0x00, 0xff, 0x00 }, {  31, 0x00, 0xff, 0x5f },
	{  32, 0x00, 0xff, 0x87 }, {  33, 0x00, 0xff, 0xaf },
	{  34, 0x00, 0xff, 0xd7 }, {  35, 0x00, 0xff, 0xff },
	{  36, 0x5f, 0x00, 0x00 }, {  37, 0x5f, 0x00, 0x5f },
	{  38, 0x5f, 0x00, 0x87 }, {  39, 0x5f, 0x00, 0xaf },
	{  40, 0x5f, 0x00, 0xd7 }, {  41, 0x5f, 0x00, 0xff },
	{  42, 0x5f, 0x5f, 0x00 }, {  43, 0x5f, 0x5f, 0x5f },
	{  44, 0x5f, 0x5f, 0x87 }, {  45, 0x5f, 0x5f, 0xaf },
	{  46, 0x5f, 0x5f, 0xd7 }, {  47, 0x5f, 0x5f, 0xff },
	{  48, 0x5f, 0x87, 0x00 }, {  49, 0x5f, 0x87, 0x5f },
	{  50, 0x5f, 0x87, 0x87 }, {  51, 0x5f, 0x87, 0xaf },
	{  52, 0x5f, 0x87, 0xd7 }, {  53, 0x5f, 0x87, 0xff },
	{  54, 0x5f, 0xaf, 0x00 }, {  55, 0x5f, 0xaf, 0x5f },
	{  56, 0x5f, 0xaf, 0x87 }, {  57, 0x5f, 0xaf, 0xaf },
	{  58, 0x5f, 0xaf, 0xd7 }, {  59, 0x5f, 0xaf, 0xff },
	{  60, 0x5f, 0xd7, 0x00 }, {  61, 0x5f, 0xd7, 0x5f },
	{  62, 0x5f, 0xd7, 0x87 }, {  63, 0x5f, 0xd7, 0xaf },
	{  64, 0x5f, 0xd7, 0xd7 }, {  65, 0x5f, 0xd7, 0xff },
	{  66, 0x5f, 0xff, 0x00 }, {  67, 0x5f, 0xff, 0x5f },
	{  68, 0x5f, 0xff, 0x87 }, {  69, 0x5f, 0xff, 0xaf },
	{  70, 0x5f, 0xff, 0xd7 }, {  71, 0x5f, 0xff, 0xff },
	{  72, 0x87, 0x00, 0x00 }, {  73, 0x87, 0x00, 0x5f },
	{  74, 0x87, 0x00, 0x87 }, {  75, 0x87, 0x00, 0xaf },
	{  76, 0x87, 0x00, 0xd7 }, {  77, 0x87, 0x00, 0xff },
	{  78, 0x87, 0x5f, 0x00 }, {  79, 0x87, 0x5f, 0x5f },
	{  80, 0x87, 0x5f, 0x87 }, {  81, 0x87, 0x5f, 0xaf },
	{  82, 0x87, 0x5f, 0xd7 }, {  83, 0x87, 0x5f, 0xff },
	{  84, 0x87, 0x87, 0x00 }, {  85, 0x87, 0x87, 0x5f },
	{  86, 0x87, 0x87, 0x87 }, {  87, 0x87, 0x87, 0xaf },
	{  88, 0x87, 0x87, 0xd7 }, {  89, 0x87, 0x87, 0xff },
	{  90, 0x87, 0xaf, 0x00 }, {  91, 0x87, 0xaf, 0x5f },
	{  92, 0x87, 0xaf, 0x87 }, {  93, 0x87, 0xaf, 0xaf },
	{  94, 0x87, 0xaf, 0xd7 }, {  95, 0x87, 0xaf, 0xff },
	{  96, 0x87, 0xd7, 0x00 }, {  97, 0x87, 0xd7, 0x5f },
	{  98, 0x87, 0xd7, 0x87 }, {  99, 0x87, 0xd7, 0xaf },
	{ 100, 0x87, 0xd7, 0xd7 }, { 101, 0x87, 0xd7, 0xff },
	{ 102, 0x87, 0xff, 0x00 }, { 103, 0x87, 0xff, 0x5f },
	{ 104, 0x87, 0xff, 0x87 }, { 105, 0x87, 0xff, 0xaf },
	{ 106, 0x87, 0xff, 0xd7 }, { 107, 0x87, 0xff, 0xff },
	{ 108, 0xaf, 0x00, 0x00 }, { 109, 0xaf, 0x00, 0x5f },
	{ 110, 0xaf, 0x00, 0x87 }, { 111, 0xaf, 0x00, 0xaf },
	{ 112, 0xaf, 0x00, 0xd7 }, { 113, 0xaf, 0x00, 0xff },
	{ 114, 0xaf, 0x5f, 0x00 }, { 115, 0xaf, 0x5f, 0x5f },
	{ 116, 0xaf, 0x5f, 0x87 }, { 117, 0xaf, 0x5f, 0xaf },
	{ 118, 0xaf, 0x5f, 0xd7 }, { 119, 0xaf, 0x5f, 0xff },
	{ 120, 0xaf, 0x87, 0x00 }, { 121, 0xaf, 0x87, 0x5f },
	{ 122, 0xaf, 0x87, 0x87 }, { 123, 0xaf, 0x87, 0xaf },
	{ 124, 0xaf, 0x87, 0xd7 }, { 125, 0xaf, 0x87, 0xff },
	{ 126, 0xaf, 0xaf, 0x00 }, { 127, 0xaf, 0xaf, 0x5f },
	{ 128, 0xaf, 0xaf, 0x87 }, { 129, 0xaf, 0xaf, 0xaf },
	{ 130, 0xaf, 0xaf, 0xd7 }, { 131, 0xaf, 0xaf, 0xff },
	{ 132, 0xaf, 0xd7, 0x00 }, { 133, 0xaf, 0xd7, 0x5f },
	{ 134, 0xaf, 0xd7, 0x87 }, { 135, 0xaf, 0xd7, 0xaf },
	{ 136, 0xaf, 0xd7, 0xd7 }, { 137, 0xaf, 0xd7, 0xff },
	{ 138, 0xaf, 0xff, 0x00 }, { 139, 0xaf, 0xff, 0x5f },
	{ 140, 0xaf, 0xff, 0x87 }, { 141, 0xaf, 0xff, 0xaf },
	{ 142, 0xaf, 0xff, 0xd7 }, { 143, 0xaf, 0xff, 0xff },
	{ 144, 0xd7, 0x00, 0x00 }, { 145, 0xd7, 0x00, 0x5f },
	{ 146, 0xd7, 0x00, 0x87 }, { 147, 0xd7, 0x00, 0xaf },
	{ 148, 0xd7, 0x00, 0xd7 }, { 149, 0xd7, 0x00, 0xff },
	{ 150, 0xd7, 0x5f, 0x00 }, { 151, 0xd7, 0x5f, 0x5f },
	{ 152, 0xd7, 0x5f, 0x87 }, { 153, 0xd7, 0x5f, 0xaf },
	{ 154, 0xd7, 0x5f, 0xd7 }, { 155, 0xd7, 0x5f, 0xff },
	{ 156, 0xd7, 0x87, 0x00 }, { 157, 0xd7, 0x87, 0x5f },
	{ 158, 0xd7, 0x87, 0x87 }, { 159, 0xd7, 0x87, 0xaf },
	{ 160, 0xd7, 0x87, 0xd7 }, { 161, 0xd7, 0x87, 0xff },
	{ 162, 0xd7, 0xaf, 0x00 }, { 163, 0xd7, 0xaf, 0x5f },
	{ 164, 0xd7, 0xaf, 0x87 }, { 165, 0xd7, 0xaf, 0xaf },
	{ 166, 0xd7, 0xaf, 0xd7 }, { 167, 0xd7, 0xaf, 0xff },
	{ 168, 0xd7, 0xd7, 0x00 }, { 169, 0xd7, 0xd7, 0x5f },
	{ 170, 0xd7, 0xd7, 0x87 }, { 171, 0xd7, 0xd7, 0xaf },
	{ 172, 0xd7, 0xd7, 0xd7 }, { 173, 0xd7, 0xd7, 0xff },
	{ 174, 0xd7, 0xff, 0x00 }, { 175, 0xd7, 0xff, 0x5f },
	{ 176, 0xd7, 0xff, 0x87 }, { 177, 0xd7, 0xff, 0xaf },
	{ 178, 0xd7, 0xff, 0xd7 }, { 179, 0xd7, 0xff, 0xff },
	{ 180, 0xff, 0x00, 0x00 }, { 181, 0xff, 0x00, 0x5f },
	{ 182, 0xff, 0x00, 0x87 }, { 183, 0xff, 0x00, 0xaf },
	{ 184, 0xff, 0x00, 0xd7 }, { 185, 0xff, 0x00, 0xff },
	{ 186, 0xff, 0x5f, 0x00 }, { 187, 0xff, 0x5f, 0x5f },
	{ 188, 0xff, 0x5f, 0x87 }, { 189, 0xff, 0x5f, 0xaf },
	{ 190, 0xff, 0x5f, 0xd7 }, { 191, 0xff, 0x5f, 0xff },
	{ 192, 0xff, 0x87, 0x00 }, { 193, 0xff, 0x87, 0x5f },
	{ 194, 0xff, 0x87, 0x87 }, { 195, 0xff, 0x87, 0xaf },
	{ 196, 0xff, 0x87, 0xd7 }, { 197, 0xff, 0x87, 0xff },
	{ 198, 0xff, 0xaf, 0x00 }, { 199, 0xff, 0xaf, 0x5f },
	{ 200, 0xff, 0xaf, 0x87 }, { 201, 0xff, 0xaf, 0xaf },
	{ 202, 0xff, 0xaf, 0xd7 }, { 203, 0xff, 0xaf, 0xff },
	{ 204, 0xff, 0xd7, 0x00 }, { 205, 0xff, 0xd7, 0x5f },
	{ 206, 0xff, 0xd7, 0x87 }, { 207, 0xff, 0xd7, 0xaf },
	{ 208, 0xff, 0xd7, 0xd7 }, { 209, 0xff, 0xd7, 0xff },
	{ 210, 0xff, 0xff, 0x00 }, { 211, 0xff, 0xff, 0x5f },
	{ 212, 0xff, 0xff, 0x87 }, { 213, 0xff, 0xff, 0xaf },
	{ 214, 0xff, 0xff, 0xd7 }, { 215, 0xff, 0xff, 0xff },
	{ 216, 0x08, 0x08, 0x08 }, { 217, 0x12, 0x12, 0x12 },
	{ 218, 0x1c, 0x1c, 0x1c }, { 219, 0x26, 0x26, 0x26 },
	{ 220, 0x30, 0x30, 0x30 }, { 221, 0x3a, 0x3a, 0x3a },
	{ 222, 0x44, 0x44, 0x44 }, { 223, 0x4e, 0x4e, 0x4e },
	{ 224, 0x58, 0x58, 0x58 }, { 225, 0x62, 0x62, 0x62 },
	{ 226, 0x6c, 0x6c, 0x6c }, { 227, 0x76, 0x76, 0x76 },
	{ 228, 0x80, 0x80, 0x80 }, { 229, 0x8a, 0x8a, 0x8a },
	{ 230, 0x94, 0x94, 0x94 }, { 231, 0x9e, 0x9e, 0x9e },
	{ 232, 0xa8, 0xa8, 0xa8 }, { 233, 0xb2, 0xb2, 0xb2 },
	{ 234, 0xbc, 0xbc, 0xbc }, { 235, 0xc6, 0xc6, 0xc6 },
	{ 236, 0xd0, 0xd0, 0xd0 }, { 237, 0xda, 0xda, 0xda },
	{ 238, 0xe4, 0xe4, 0xe4 }, { 239, 0xee, 0xee, 0xee },
};
const struct colour_rgb colour_to_256[] = {
	{   0, 0x00, 0x00, 0x00 }, {   1, 0x00, 0x00, 0x5f },
	{   2, 0x00, 0x00, 0x87 }, {   3, 0x00, 0x00, 0xaf },
	{   4, 0x00, 0x00, 0xd7 }, {   5, 0x00, 0x00, 0xff },
	{   6, 0x00, 0x5f, 0x00 }, {   7, 0x00, 0x5f, 0x5f },
	{   8, 0x00, 0x5f, 0x87 }, {   9, 0x00, 0x5f, 0xaf },
	{  10, 0x00, 0x5f, 0xd7 }, {  11, 0x00, 0x5f, 0xff },
	{  12, 0x00, 0x87, 0x00 }, {  13, 0x00, 0x87, 0x5f },
	{  14, 0x00, 0x87, 0x87 }, {  15, 0x00, 0x87, 0xaf },
	{  16, 0x00, 0x87, 0xd7 }, {  17, 0x00, 0x87, 0xff },
	{  18, 0x00, 0xaf, 0x00 }, {  19, 0x00, 0xaf, 0x5f },
	{  20, 0x00, 0xaf, 0x87 }, {  21, 0x00, 0xaf, 0xaf },
	{  22, 0x00, 0xaf, 0xd7 }, {  23, 0x00, 0xaf, 0xff },
	{  24, 0x00, 0xd7, 0x00 }, {  25, 0x00, 0xd7, 0x5f },
	{  26, 0x00, 0xd7, 0x87 }, {  27, 0x00, 0xd7, 0xaf },
	{  28, 0x00, 0xd7, 0xd7 }, {  29, 0x00, 0xd7, 0xff },
	{  30, 0x00, 0xff, 0x00 }, {  31, 0x00, 0xff, 0x5f },
	{  32, 0x00, 0xff, 0x87 }, {  33, 0x00, 0xff, 0xaf },
	{  34, 0x00, 0xff, 0xd7 }, {  35, 0x00, 0xff, 0xff },
	{ 216, 0x08, 0x08, 0x08 }, { 217, 0x12, 0x12, 0x12 },
	{ 218, 0x1c, 0x1c, 0x1c }, { 219, 0x26, 0x26, 0x26 },
	{ 220, 0x30, 0x30, 0x30 }, { 221, 0x3a, 0x3a, 0x3a },
	{ 222, 0x44, 0x44, 0x44 }, { 223, 0x4e, 0x4e, 0x4e },
	{ 224, 0x58, 0x58, 0x58 }, {  36, 0x5f, 0x00, 0x00 },
	{  37, 0x5f, 0x00, 0x5f }, {  38, 0x5f, 0x00, 0x87 },
	{  39, 0x5f, 0x00, 0xaf }, {  40, 0x5f, 0x00, 0xd7 },
	{  41, 0x5f, 0x00, 0xff }, {  42, 0x5f, 0x5f, 0x00 },
	{  43, 0x5f, 0x5f, 0x5f }, {  44, 0x5f, 0x5f, 0x87 },
	{  45, 0x5f, 0x5f, 0xaf }, {  46, 0x5f, 0x5f, 0xd7 },
	{  47, 0x5f, 0x5f, 0xff }, {  48, 0x5f, 0x87, 0x00 },
	{  49, 0x5f, 0x87, 0x5f }, {  50, 0x5f, 0x87, 0x87 },
	{  51, 0x5f, 0x87, 0xaf }, {  52, 0x5f, 0x87, 0xd7 },
	{  53, 0x5f, 0x87, 0xff }, {  54, 0x5f, 0xaf, 0x00 },
	{  55, 0x5f, 0xaf, 0x5f }, {  56, 0x5f, 0xaf, 0x87 },
	{  57, 0x5f, 0xaf, 0xaf }, {  58, 0x5f, 0xaf, 0xd7 },
	{  59, 0x5f, 0xaf, 0xff }, {  60, 0x5f, 0xd7, 0x00 },
	{  61, 0x5f, 0xd7, 0x5f }, {  62, 0x5f, 0xd7, 0x87 },
	{  63, 0x5f, 0xd7, 0xaf }, {  64, 0x5f, 0xd7, 0xd7 },
	{  65, 0x5f, 0xd7, 0xff }, {  66, 0x5f, 0xff, 0x00 },
	{  67, 0x5f, 0xff, 0x5f }, {  68, 0x5f, 0xff, 0x87 },
	{  69, 0x5f, 0xff, 0xaf }, {  70, 0x5f, 0xff, 0xd7 },
	{  71, 0x5f, 0xff, 0xff }, { 225, 0x62, 0x62, 0x62 },
	{ 226, 0x6c, 0x6c, 0x6c }, { 227, 0x76, 0x76, 0x76 },
	{ 228, 0x80, 0x80, 0x80 }, {  72, 0x87, 0x00, 0x00 },
	{  73, 0x87, 0x00, 0x5f }, {  74, 0x87, 0x00, 0x87 },
	{  75, 0x87, 0x00, 0xaf }, {  76, 0x87, 0x00, 0xd7 },
	{  77, 0x87, 0x00, 0xff }, {  78, 0x87, 0x5f, 0x00 },
	{  79, 0x87, 0x5f, 0x5f }, {  80, 0x87, 0x5f, 0x87 },
	{  81, 0x87, 0x5f, 0xaf }, {  82, 0x87, 0x5f, 0xd7 },
	{  83, 0x87, 0x5f, 0xff }, {  84, 0x87, 0x87, 0x00 },
	{  85, 0x87, 0x87, 0x5f }, {  86, 0x87, 0x87, 0x87 },
	{  87, 0x87, 0x87, 0xaf }, {  88, 0x87, 0x87, 0xd7 },
	{  89, 0x87, 0x87, 0xff }, {  90, 0x87, 0xaf, 0x00 },
	{  91, 0x87, 0xaf, 0x5f }, {  92, 0x87, 0xaf, 0x87 },
	{  93, 0x87, 0xaf, 0xaf }, {  94, 0x87, 0xaf, 0xd7 },
	{  95, 0x87, 0xaf, 0xff }, {  96, 0x87, 0xd7, 0x00 },
	{  97, 0x87, 0xd7, 0x5f }, {  98, 0x87, 0xd7, 0x87 },
	{  99, 0x87, 0xd7, 0xaf }, { 100, 0x87, 0xd7, 0xd7 },
	{ 101, 0x87, 0xd7, 0xff }, { 102, 0x87, 0xff, 0x00 },
	{ 103, 0x87, 0xff, 0x5f }, { 104, 0x87, 0xff, 0x87 },
	{ 105, 0x87, 0xff, 0xaf }, { 106, 0x87, 0xff, 0xd7 },
	{ 107, 0x87, 0xff, 0xff }, { 229, 0x8a, 0x8a, 0x8a },
	{ 230, 0x94, 0x94, 0x94 }, { 231, 0x9e, 0x9e, 0x9e },
	{ 232, 0xa8, 0xa8, 0xa8 }, { 108, 0xaf, 0x00, 0x00 },
	{ 109, 0xaf, 0x00, 0x5f }, { 110, 0xaf, 0x00, 0x87 },
	{ 111, 0xaf, 0x00, 0xaf }, { 112, 0xaf, 0x00, 0xd7 },
	{ 113, 0xaf, 0x00, 0xff }, { 114, 0xaf, 0x5f, 0x00 },
	{ 115, 0xaf, 0x5f, 0x5f }, { 116, 0xaf, 0x5f, 0x87 },
	{ 117, 0xaf, 0x5f, 0xaf }, { 118, 0xaf, 0x5f, 0xd7 },
	{ 119, 0xaf, 0x5f, 0xff }, { 120, 0xaf, 0x87, 0x00 },
	{ 121, 0xaf, 0x87, 0x5f }, { 122, 0xaf, 0x87, 0x87 },
	{ 123, 0xaf, 0x87, 0xaf }, { 124, 0xaf, 0x87, 0xd7 },
	{ 125, 0xaf, 0x87, 0xff }, { 126, 0xaf, 0xaf, 0x00 },
	{ 127, 0xaf, 0xaf, 0x5f }, { 128, 0xaf, 0xaf, 0x87 },
	{ 129, 0xaf, 0xaf, 0xaf }, { 130, 0xaf, 0xaf, 0xd7 },
	{ 131, 0xaf, 0xaf, 0xff }, { 132, 0xaf, 0xd7, 0x00 },
	{ 133, 0xaf, 0xd7, 0x5f }, { 134, 0xaf, 0xd7, 0x87 },
	{ 135, 0xaf, 0xd7, 0xaf }, { 136, 0xaf, 0xd7, 0xd7 },
	{ 137, 0xaf, 0xd7, 0xff }, { 138, 0xaf, 0xff, 0x00 },
	{ 139, 0xaf, 0xff, 0x5f }, { 140, 0xaf, 0xff, 0x87 },
	{ 141, 0xaf, 0xff, 0xaf }, { 142, 0xaf, 0xff, 0xd7 },
	{ 143, 0xaf, 0xff, 0xff }, { 233, 0xb2, 0xb2, 0xb2 },
	{ 234, 0xbc, 0xbc, 0xbc }, { 235, 0xc6, 0xc6, 0xc6 },
	{ 236, 0xd0, 0xd0, 0xd0 }, { 144, 0xd7, 0x00, 0x00 },
	{ 145, 0xd7, 0x00, 0x5f }, { 146, 0xd7, 0x00, 0x87 },
	{ 147, 0xd7, 0x00, 0xaf }, { 148, 0xd7, 0x00, 0xd7 },
	{ 149, 0xd7, 0x00, 0xff }, { 150, 0xd7, 0x5f, 0x00 },
	{ 151, 0xd7, 0x5f, 0x5f }, { 152, 0xd7, 0x5f, 0x87 },
	{ 153, 0xd7, 0x5f, 0xaf }, { 154, 0xd7, 0x5f, 0xd7 },
	{ 155, 0xd7, 0x5f, 0xff }, { 156, 0xd7, 0x87, 0x00 },
	{ 157, 0xd7, 0x87, 0x5f }, { 158, 0xd7, 0x87, 0x87 },
	{ 159, 0xd7, 0x87, 0xaf }, { 160, 0xd7, 0x87, 0xd7 },
	{ 161, 0xd7, 0x87, 0xff }, { 162, 0xd7, 0xaf, 0x00 },
	{ 163, 0xd7, 0xaf, 0x5f }, { 164, 0xd7, 0xaf, 0x87 },
	{ 165, 0xd7, 0xaf, 0xaf }, { 166, 0xd7, 0xaf, 0xd7 },
	{ 167, 0xd7, 0xaf, 0xff }, { 168, 0xd7, 0xd7, 0x00 },
	{ 169, 0xd7, 0xd7, 0x5f }, { 170, 0xd7, 0xd7, 0x87 },
	{ 171, 0xd7, 0xd7, 0xaf }, { 172, 0xd7, 0xd7, 0xd7 },
	{ 173, 0xd7, 0xd7, 0xff }, { 174, 0xd7, 0xff, 0x00 },
	{ 175, 0xd7, 0xff, 0x5f }, { 176, 0xd7, 0xff, 0x87 },
	{ 177, 0xd7, 0xff, 0xaf }, { 178, 0xd7, 0xff, 0xd7 },
	{ 179, 0xd7, 0xff, 0xff }, { 237, 0xda, 0xda, 0xda },
	{ 238, 0xe4, 0xe4, 0xe4 }, { 239, 0xee, 0xee, 0xee },
	{ 180, 0xff, 0x00, 0x00 }, { 181, 0xff, 0x00, 0x5f },
	{ 182, 0xff, 0x00, 0x87 }, { 183, 0xff, 0x00, 0xaf },
	{ 184, 0xff, 0x00, 0xd7 }, { 185, 0xff, 0x00, 0xff },
	{ 186, 0xff, 0x5f, 0x00 }, { 187, 0xff, 0x5f, 0x5f },
	{ 188, 0xff, 0x5f, 0x87 }, { 189, 0xff, 0x5f, 0xaf },
	{ 190, 0xff, 0x5f, 0xd7 }, { 191, 0xff, 0x5f, 0xff },
	{ 192, 0xff, 0x87, 0x00 }, { 193, 0xff, 0x87, 0x5f },
	{ 194, 0xff, 0x87, 0x87 }, { 195, 0xff, 0x87, 0xaf },
	{ 196, 0xff, 0x87, 0xd7 }, { 197, 0xff, 0x87, 0xff },
	{ 198, 0xff, 0xaf, 0x00 }, { 199, 0xff, 0xaf, 0x5f },
	{ 200, 0xff, 0xaf, 0x87 }, { 201, 0xff, 0xaf, 0xaf },
	{ 202, 0xff, 0xaf, 0xd7 }, { 203, 0xff, 0xaf, 0xff },
	{ 204, 0xff, 0xd7, 0x00 }, { 205, 0xff, 0xd7, 0x5f },
	{ 206, 0xff, 0xd7, 0x87 }, { 207, 0xff, 0xd7, 0xaf },
	{ 208, 0xff, 0xd7, 0xd7 }, { 209, 0xff, 0xd7, 0xff },
	{ 210, 0xff, 0xff, 0x00 }, { 211, 0xff, 0xff, 0x5f },
	{ 212, 0xff, 0xff, 0x87 }, { 213, 0xff, 0xff, 0xaf },
	{ 214, 0xff, 0xff, 0xd7 }, { 215, 0xff, 0xff, 0xff },
};
const struct lab_index from256_to_lab[] = {
    { 0, 0.0, 0.0, 0.0 },
    { 1, 7.4606605, 38.391033, -52.344097 },
    { 2, 14.108799, 49.36623, -67.24102 },
    { 3, 20.416779, 59.708763, -81.32842 },
    { 4, 26.461218, 69.619194, -94.82728 },
    { 5, 32.29701, 79.18753, -107.86016 },
    { 6, 34.36292, -41.841465, 40.383327 },
    { 7, 36.00317, -23.346355, -6.860655 },
    { 8, 37.721073, -8.280285, -28.838133 },
    { 9, 40.04471, 8.05036, -49.07793 },
    { 10, 42.896244, 24.23208, -67.66586 },
    { 11, 46.1791, 39.611565, -84.835625 },
    { 12, 48.669174, -53.72709, 51.854748 },
    { 13, 49.680824, -41.468204, 12.871272 },
    { 14, 50.775364, -29.978197, -8.809515 },
    { 15, 52.309746, -16.087675, -29.668385 },
    { 16, 54.27165, -0.98452127, -49.346596 },
    { 17, 56.628674, 14.436604, -67.82577 },
    { 18, 62.21777, -64.983246, 62.71864 },
    { 19, 62.91396, -56.27478, 30.552782 },
    { 20, 63.677486, -47.533726, 9.989756 },
    { 21, 64.76521, -36.258816, -10.655163 },
    { 22, 66.18427, -23.179976, -30.65918 },
    { 23, 67.92867, -9.021859, -49.792244 },
    { 24, 75.20032, -75.769135, 73.12865 },
    { 25, 75.71408, -69.238106, 46.415764 },
    { 26, 76.28132, -62.437084, 27.35887 },
    { 27, 77.09612, -53.31778, 7.414748 },
    { 28, 78.170586, -42.277035, -12.423701 },
    { 29, 79.508484, -29.803875, -31.743847 },
    { 30, 87.73472, -86.1827, 83.17931 },
    { 31, 88.13254, -81.0793, 60.78427 },
    { 32, 88.57342, -75.64987, 43.369232 },
    { 33, 89.20966, -68.192314, 24.408745 },
    { 34, 90.0539, -58.903847, 5.054876 },
    { 35, 91.11321, -48.087513, -14.131192 },
    { 36, 17.616213, 38.884674, 27.208158 },
    { 37, 21.055193, 47.692493, -29.53032 },
    { 38, 24.265488, 55.109283, -50.109932 },
    { 39, 28.18846, 63.497265, -68.1894 },
    { 40, 32.565033, 72.27846, -84.49514 },
    { 41, 37.209053, 81.15774, -99.53934 },
    { 42, 38.9288, -10.464277, 45.868793 },
    { 43, 40.31768, 0.0, -1.110223e-14 },
    { 44, 41.79241, 9.716889, -22.184772 },
    { 45, 43.816566, 21.358557, -42.829514 },
    { 46, 46.34128, 33.91063, -61.915176 },
    { 47, 49.295486, 46.65104, -79.60936 },
    { 48, 51.565357, -31.106932, 55.36229 },
    { 49, 52.49389, -22.366047, 17.186386 },
    { 50, 53.502316, -13.755704, -4.459624 },
    { 51, 54.922245, -2.8603141, -25.412905 },
    { 52, 56.74766, 9.522796, -45.263798 },
    { 53, 58.95397, 22.669718, -63.96192 },
    { 54, 64.23503, -48.20328, 65.170135 },
    { 55, 64.89708, -41.171032, 33.4874 },
    { 56, 65.62413, -33.96333, 13.012984 },
    { 57, 66.66157, -24.46454, -7.6263328 },
    { 58, 68.01783, -13.189288, -27.680086 },
    { 59, 69.68914, -0.7081696, -46.900097 },
    { 60, 76.698, -62.88067, 74.95185 },
    { 61, 77.19543, -57.22148, 48.537292 },
    { 62, 77.74494, -51.270866, 29.570902 },
    { 63, 78.53481, -43.206104, 9.664413 },
    { 64, 79.577354, -33.32128, -10.175423 },
    { 65, 80.876945, -22.010103, -29.524782 },
    { 66, 88.898346, -75.96836, 84.59722 },
    { 67, 89.28744, -71.3547, 62.392487 },
    { 68, 89.71876, -66.42212, 45.05557 },
    { 69, 90.34141, -59.60852, 26.14048 },
    { 70, 91.167984, -51.063885, 6.8044615 },
    { 71, 92.2057, -41.03875, -12.384589 },
    { 72, 27.165344, 49.93038, 40.136703 },
    { 73, 29.35841, 55.72505, -15.903004 },
    { 74, 31.581213, 61.240177, -37.9188 },
    { 75, 34.491547, 68.043434, -57.61184 },
    { 76, 37.945, 75.65295, -75.43297 },
    { 77, 41.798485, 83.7069, -91.79184 },
    { 78, 43.266003, 9.134601, 50.930046 },
    { 79, 44.46504, 16.311056, 6.5127473 },
    { 80, 45.750668, 23.372986, -15.766716 },
    { 81, 47.534435, 32.300953, -36.702984 },
    { 82, 49.787277, 42.444473, -56.184498 },
    { 83, 52.457916, 53.224033, -74.32065 },
    { 84, 54.532055, -13.436794, 58.898434 },
    { 85, 55.385513, -6.768104, 21.580881 },
    { 86, 56.315464, 0.0, 0.0 },
    { 87, 57.630005, 8.825716, -21.02135 },
    { 88, 59.328133, 19.179546, -41.022232 },
    { 89, 61.391857, 30.508211, -59.920734 },
    { 90, 66.374916, -33.335613, 67.74582 },
    { 91, 67.00341, -27.527159, 36.582855 },
    { 92, 67.69448, -21.482407, 16.21252 },
    { 93, 68.68212, -13.384681, -4.410659 },
    { 94, 69.97589, -3.5940607, -24.507229 },
    { 95, 71.574005, 7.4478703, -43.80998 },
    { 96, 78.3159, -50.585262, 76.909134 },
    { 97, 78.79654, -45.65142, 50.81854 },
    { 98, 79.327805, -40.421776, 31.95376 },
    { 99, 80.09197, -33.269817, 12.092104 },
    { 100, 81.101524, -24.40983, -7.7450686 },
    { 101, 82.36142, -14.15498, -27.121914 },
    { 102, 90.168526, -65.770164, 86.13828 },
    { 103, 90.548416, -61.599037, 64.1416 },
    { 104, 90.96964, -57.119896, 46.891518 },
    { 105, 91.57794, -50.90079, 28.027868 },
    { 106, 92.38583, -43.05243, 8.713283 },
    { 107, 93.400696, -33.779278, -10.477097 },
    { 108, 36.20875, 60.391106, 50.573776 },
    { 109, 37.739975, 64.49527, -2.4383256 },
    { 110, 39.353428, 68.65032, -25.128733 },
    { 111, 41.54977, 74.07037, -45.86302 },
    { 112, 44.264008, 80.45846, -64.84865 },
    { 113, 47.410427, 87.52037, -82.356606 },
    { 114, 48.637024, 27.330276, 57.029236 },
    { 115, 49.649654, 32.34591, 14.536335 },
    { 116, 50.745205, 37.483208, -7.7433734 },
    { 117, 52.28093, 44.249607, -28.930918 },
    { 118, 54.244423, 52.28032, -48.806034 },
    { 119, 56.603188, 61.17828, -67.411896 },
    { 120, 58.455994, 5.073281, 63.495094 },
    { 121, 59.223236, 10.069977, 27.347967 },
    { 122, 60.062283, 15.26733, 5.8948064 },
    { 123, 61.253483, 22.225775, -15.176017 },
    { 124, 62.800705, 30.63353, -35.336723 },
    { 125, 64.69289, 40.111217, -54.465107 },
    { 126, 69.30896, -16.251886, 71.23802 },
    { 127, 69.8954, -11.599328, 40.796837 },
    { 128, 70.541245, -6.687187, 20.584976 },
    { 129, 71.466, 0.0, -2.220446e-14 },
    { 130, 72.680405, 8.238508, -20.13957 },
    { 131, 74.18496, 17.716326, -39.540672 },
    { 132, 80.57992, -35.51389, 79.627396 },
    { 133, 81.038445, -31.346972, 53.992264 },
    { 134, 81.54563, -26.892885, 35.276024 },
    { 135, 82.27584, -20.74215, 15.484094 },
    { 136, 83.24167, -13.032541, -4.3423743 },
    { 137, 84.44879, -3.9933078, -23.750847 },
    { 138, 91.96782, -52.701237, 88.30965 },
    { 139, 92.33521, -49.036705, 66.608 },
    { 140, 92.74274, -45.081852, 49.483555 },
    { 141, 93.33153, -39.55816, 30.696045 },
    { 142, 94.11398, -32.535976, 11.415197 },
    { 143, 95.09766, -24.169449, -7.773711 },
    { 144, 44.874336, 70.41479, 59.082943 },
    { 145, 46.01258, 73.48829, 10.528984 },
    { 146, 47.236694, 76.70619, -12.348565 },
    { 147, 48.94088, 81.05142, -33.68182 },
    { 148, 51.101852, 86.36454, -53.47534 },
    { 149, 53.674595, 92.44634, -71.87904 },
    { 150, 54.6953, 43.54895, 63.726902 },
    { 151, 55.54489, 47.19534, 23.494864 },
    { 152, 56.470783, 51.029175, 1.3459018 },
    { 153, 57.779846, 56.225403, -20.000217 },
    { 154, 59.47131, 62.59714, -40.20457 },
    { 155, 61.52752, 69.89737, -59.24138 },
    { 156, 63.159653, 22.859877, 68.89739 },
    { 157, 63.839584, 26.63422, 34.185577 },
    { 158, 64.585754, 30.63287, 12.941225 },
    { 159, 65.64958, 36.098164, -8.134158 },
    { 160, 67.038826, 42.864243, -28.43392 },
    { 161, 68.7486, 50.691307, -47.788933 },
    { 162, 72.96421, 1.4300884, 75.52918 },
    { 163, 73.50389, 5.1194844, 45.996426 },
    { 164, 74.09922, 9.062114, 26.00543 },
    { 165, 74.95341, 14.504796, 5.492268 },
    { 166, 76.07817, 21.324055, -14.677155 },
    { 167, 77.47621, 29.315756, -34.177876 },
    { 168, 83.4685, -18.949366, 83.06207 },
    { 169, 83.90095, -15.492573, 58.010017 },
    { 170, 84.3797, -11.768709, 39.49327 },
    { 171, 85.06967, -6.5790634, 19.80155 },
    { 172, 85.98357, 0.0, 0.0 },
    { 173, 87.12772, 7.8130693, -19.437777 },
    { 174, 94.29834, -37.668182, 91.10241 },
    { 175, 94.65045, -34.512356, 69.782906 },
    { 176, 95.04119, -31.0895, 52.825512 },
    { 177, 95.60603, -26.280205, 34.142075 },
    { 178, 96.35725, -20.119923, 14.910606 },
    { 179, 97.30252, -12.715967, -4.27075 },
    { 180, 53.24079, 80.09247, 67.20319 },
    { 181, 54.12578, 82.4922, 22.910967 },
    { 182, 55.088764, 85.05463, 0.16814028 },
    { 183, 56.447796, 88.59103, -21.450676 },
    { 184, 58.199844, 93.02512, -41.766003 },
    { 185, 60.32421, 98.23432, -60.824898 },
    { 186, 61.17775, 58.007195, 70.725235 },
    { 187, 61.892574, 60.769085, 32.94006 },
    { 188, 62.675957, 63.722878, 11.059153 },
    { 189, 63.790977, 67.80519, -10.333128 },
    { 190, 65.24397, 72.92929, -30.77314 },
    { 191, 67.027695, 78.9505, -50.165203 },
    { 192, 68.4562, 39.34704, 74.85846 },
    { 193, 69.05442, 42.256413, 41.778305 },
    { 194, 69.71295, 45.379704, 20.832596 },
    { 195, 70.65538, 49.714798, -0.1846616 },
    { 196, 71.89213, 55.183586, -20.5799 },
    { 197, 73.4231, 61.643536, -40.13216 },
    { 198, 77.23608, 18.715576, 80.467674 },
    { 199, 77.72783, 21.651873, 52.000977 },
    { 200, 78.27117, 24.81981, 32.29765 },
    { 201, 79.05235, 29.242716, 11.899649 },
    { 202, 80.083755, 34.862667, -8.273981 },
    { 203, 81.36996, 41.554745, -27.861353 },
    { 204, 86.930565, -1.923734, 87.132034 },
    { 205, 87.33459, 0.92563576, 62.778896 },
    { 206, 87.78226, 4.0156474, 44.51466 },
    { 207, 88.42815, 8.356458, 24.958584 },
    { 208, 89.28492, 13.915237, 5.2025642 },
    { 209, 90.359535, 20.594202, -14.254948 },
    { 210, 97.13927, -21.553732, 94.47797 },
    { 211, 97.47399, -18.86691, 73.62333 },
    { 212, 97.84562, -15.93939, 56.875576 },
    { 213, 98.38318, -11.803172, 38.32688 },
    { 214, 99.098694, -6.467202, 19.1639 },
    { 215, 100.0, 0.0, 0.0 },
    { 216, 2.1933985, 0.0, 0.0 },
    { 217, 5.4638886, 0.0, -5.551115e-15 },
    { 218, 10.268185, 1.3877788e-14, 0.0 },
    { 219, 15.15972, 0.0, 0.0 },
    { 220, 19.865534, 0.0, 0.0 },
    { 221, 24.42132, 0.0, -1.110223e-14 },
    { 222, 28.851902, 0.0, 0.0 },
    { 223, 33.175472, 0.0, 0.0 },
    { 224, 37.40589, 0.0, 0.0 },
    { 225, 41.554043, 0.0, 0.0 },
    { 226, 45.62869, 0.0, 0.0 },
    { 227, 49.637012, 5.551115e-14, -2.220446e-14 },
    { 228, 53.585014, 5.551115e-14, -2.220446e-14 },
    { 229, 57.477757, 0.0, 0.0 },
    { 230, 61.319584, 0.0, 0.0 },
    { 231, 65.11424, 0.0, 0.0 },
    { 232, 68.86502, 0.0, 0.0 },
    { 233, 72.57478, -5.551115e-14, 0.0 },
    { 234, 76.24609, 5.551115e-14, 0.0 },
    { 235, 79.88122, 5.551115e-14, -2.220446e-14 },
    { 236, 83.4822, -5.551115e-14, 0.0 },
    { 237, 87.05088, 0.0, 0.0 },
    { 238, 90.58892, 0.0, 0.0 },
    { 239, 94.09783, 0.0, 0.0 }
};

int	colour_cmp_rgb(const void *, const void *);

/* Compare function for bsearch(). */
int
colour_cmp_rgb(const void *lhs0, const void *rhs0)
{
	const struct colour_rgb *lhs = lhs0, *rhs = rhs0;

	if (lhs->r < rhs->r)
		return (-1);
	if (lhs->r > rhs->r)
		return (1);

	if (lhs->g < rhs->g)
		return (-1);
	if (lhs->g > rhs->g)
		return (1);

	if (lhs->b < rhs->b)
		return (-1);
	if (lhs->b > rhs->b)
		return (1);

	return (0);
}

/* Private function required by srgbtoxyz. */
static inline double
rgb_convert(u_char value)
{
        double v;

        v = (double)value / 255;
        if (v > 0.04045)
            return pow((v + 0.055) / 1.055, 2.4);
        else
            return v / 12.92;
}

/* Convert sRGB to XYZ colour space using custom profile. */
static void
srgbtoxyz(const struct cie_profile *prof, const struct colour_rgb *rgb,
          struct colour_xyz *xyz)
{
    double r, g, b;

    r = rgb_convert(rgb->r);
    g = rgb_convert(rgb->g);
    b = rgb_convert(rgb->b);

    xyz->x = prof->data[0][0]*r + prof->data[0][1]*g + prof->data[0][2]*b;
    xyz->y = prof->data[1][0]*r + prof->data[1][1]*g + prof->data[1][2]*b;
    xyz->z = prof->data[2][0]*r + prof->data[2][1]*g + prof->data[2][2]*b;
}

/* Private function required by xyztolab. */
static inline double
xyz_convert(double value)
{
    const double epsilon = 216. / 24389;
    const double kappa = 24389. / 27;

    if (value > epsilon)
        return pow(value, 1./3);
    else
        return (kappa * value + 16) / 116;
}

/* Convert XYZ to LAB colour space using custom white reference. */
static void
xyztolab(const struct white_ref *white, const struct colour_xyz *xyz,
         struct colour_lab *lab)
{
    double xr, yr, zr;

    xr = xyz->x / white->Xr;
    yr = xyz->y / white->Yr;
    zr = xyz->z / white->Zr;

    lab->L = 116 * xyz_convert(yr) - 16;
    lab->a = 500 * (xyz_convert(xr) - xyz_convert(yr));
    lab->b = 200 * (xyz_convert(yr) - xyz_convert(zr));
}


/* Convert sRGB to LAB using custom profile. */
static void
srgbtolab(const struct cie_profile *prof, const struct white_ref *white,
          const struct colour_rgb *rgb, struct colour_lab *lab)
{

    struct colour_xyz xyz;
    srgbtoxyz(prof, rgb, &xyz);
    xyztolab(white, &xyz, lab);
}


/* Convert sRGB colour to LAB using d65 profile. */
static inline void
srgbtolab_d65(const struct colour_rgb *rgb, struct colour_lab *lab)
{
    srgbtolab(&srgb_d65, &d65_white, rgb, lab);
}

/* Work out the nearest colour from the 256 colour set. */
int
colour_find_rgb(u_char r, u_char g, u_char b)
{
	struct colour_rgb	rgb = { .r = r, .g = g, .b = b }, *found;
    struct colour_lab   lab;
	u_int			    colour, i;
	double              distance, lowest, dl, da, db;

	found = bsearch(&rgb, colour_to_256, nitems(colour_to_256),
	    sizeof colour_to_256[0], colour_cmp_rgb);
	if (found != NULL)
		return (16 + found->i);

	colour = 16;
	lowest = INFINITY;
    srgbtolab_d65(&rgb, &lab);
	for (i = 0; i < 240; i++) {
        dl = (double)from256_to_lab[i].l - lab.L;
        da = (double)from256_to_lab[i].a - lab.a;
        db = (double)from256_to_lab[i].b - lab.b;

		distance = dl * dl + da * da + db * db;
		if (distance < lowest) {
			lowest = distance;
			colour = 16 + i;
		}
	}
	return (colour);
}

/* Set grid cell foreground colour. */
void
colour_set_fg(struct grid_cell *gc, int c)
{
	if (c & 0x100)
		gc->flags |= GRID_FLAG_FG256;
	gc->fg = c;
}

/* Set grid cell background colour. */
void
colour_set_bg(struct grid_cell *gc, int c)
{
	if (c & 0x100)
		gc->flags |= GRID_FLAG_BG256;
	gc->bg = c;
}

/* Convert colour to a string. */
const char *
colour_tostring(int c)
{
	static char	s[32];

	if (c & 0x100) {
		xsnprintf(s, sizeof s, "colour%d", c & ~0x100);
		return (s);
	}

	switch (c) {
	case 0:
		return ("black");
	case 1:
		return ("red");
	case 2:
		return ("green");
	case 3:
		return ("yellow");
	case 4:
		return ("blue");
	case 5:
		return ("magenta");
	case 6:
		return ("cyan");
	case 7:
		return ("white");
	case 8:
		return ("default");
	case 90:
		return ("brightblack");
	case 91:
		return ("brightred");
	case 92:
		return ("brightgreen");
	case 93:
		return ("brightyellow");
	case 94:
		return ("brightblue");
	case 95:
		return ("brightmagenta");
	case 96:
		return ("brightcyan");
	case 97:
		return ("brightwhite");
	}
	return (NULL);
}

/* Convert colour from string. */
int
colour_fromstring(const char *s)
{
	const char	*errstr;
	const char	*cp;
	int		 n;
	u_char		 r, g, b;

	if (*s == '#' && strlen(s) == 7) {
		for (cp = s + 1; isxdigit((u_char) *cp); cp++)
			;
		if (*cp != '\0')
			return (-1);
		n = sscanf(s + 1, "%2hhx%2hhx%2hhx", &r, &g, &b);
		if (n != 3)
			return (-1);
		return (colour_find_rgb(r, g, b) | 0x100);
	}

	if (strncasecmp(s, "colour", (sizeof "colour") - 1) == 0) {
		n = strtonum(s + (sizeof "colour") - 1, 0, 255, &errstr);
		if (errstr != NULL)
			return (-1);
		return (n | 0x100);
	}

	if (strcasecmp(s, "black") == 0 || strcmp(s, "0") == 0)
		return (0);
	if (strcasecmp(s, "red") == 0 || strcmp(s, "1") == 0)
		return (1);
	if (strcasecmp(s, "green") == 0 || strcmp(s, "2") == 0)
		return (2);
	if (strcasecmp(s, "yellow") == 0 || strcmp(s, "3") == 0)
		return (3);
	if (strcasecmp(s, "blue") == 0 || strcmp(s, "4") == 0)
		return (4);
	if (strcasecmp(s, "magenta") == 0 || strcmp(s, "5") == 0)
		return (5);
	if (strcasecmp(s, "cyan") == 0 || strcmp(s, "6") == 0)
		return (6);
	if (strcasecmp(s, "white") == 0 || strcmp(s, "7") == 0)
		return (7);
	if (strcasecmp(s, "default") == 0 || strcmp(s, "8") == 0)
		return (8);
	if (strcasecmp(s, "brightblack") == 0 || strcmp(s, "90") == 0)
		return (90);
	if (strcasecmp(s, "brightred") == 0 || strcmp(s, "91") == 0)
		return (91);
	if (strcasecmp(s, "brightgreen") == 0 || strcmp(s, "92") == 0)
		return (92);
	if (strcasecmp(s, "brightyellow") == 0 || strcmp(s, "93") == 0)
		return (93);
	if (strcasecmp(s, "brightblue") == 0 || strcmp(s, "94") == 0)
		return (94);
	if (strcasecmp(s, "brightmagenta") == 0 || strcmp(s, "95") == 0)
		return (95);
	if (strcasecmp(s, "brightcyan") == 0 || strcmp(s, "96") == 0)
		return (96);
	if (strcasecmp(s, "brightwhite") == 0 || strcmp(s, "97") == 0)
		return (97);
	return (-1);
}

/* Convert 256 colour palette to 16. */
u_char
colour_256to16(u_char c)
{
	static const u_char table[256] = {
		 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15,
		 0,  4,  4,  4, 12, 12,  2,  6,  4,  4, 12, 12,  2,  2,  6,  4,
		12, 12,  2,  2,  2,  6, 12, 12, 10, 10, 10, 10, 14, 12, 10, 10,
		10, 10, 10, 14,  1,  5,  4,  4, 12, 12,  3,  8,  4,  4, 12, 12,
		 2,  2,  6,  4, 12, 12,  2,  2,  2,  6, 12, 12, 10, 10, 10, 10,
		14, 12, 10, 10, 10, 10, 10, 14,  1,  1,  5,  4, 12, 12,  1,  1,
		 5,  4, 12, 12,  3,  3,  8,  4, 12, 12,  2,  2,  2,  6, 12, 12,
		10, 10, 10, 10, 14, 12, 10, 10, 10, 10, 10, 14,  1,  1,  1,  5,
		12, 12,  1,  1,  1,  5, 12, 12,  1,  1,  1,  5, 12, 12,  3,  3,
		 3,  7, 12, 12, 10, 10, 10, 10, 14, 12, 10, 10, 10, 10, 10, 14,
		 9,  9,  9,  9, 13, 12,  9,  9,  9,  9, 13, 12,  9,  9,  9,  9,
		13, 12,  9,  9,  9,  9, 13, 12, 11, 11, 11, 11,  7, 12, 10, 10,
		10, 10, 10, 14,  9,  9,  9,  9,  9, 13,  9,  9,  9,  9,  9, 13,
		 9,  9,  9,  9,  9, 13,  9,  9,  9,  9,  9, 13,  9,  9,  9,  9,
		 9, 13, 11, 11, 11, 11, 11, 15,  0,  0,  0,  0,  0,  0,  8,  8,
		 8,  8,  8,  8,  7,  7,  7,  7,  7,  7, 15, 15, 15, 15, 15, 15
	};

	return (table[c]);
}
